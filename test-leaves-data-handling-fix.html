<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leaves Data Handling Fix Test</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test-case { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .employee-card { display: flex; align-items: center; gap: 10px; margin: 10px 0; }
        .avatar { width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; }
        .avatar-primary { background-color: #dbeafe; color: #1d4ed8; }
        .avatar-neutral { background-color: #f3f4f6; color: #6b7280; }
    </style>
</head>
<body>
    <h1>Leaves Data Handling Fix Test</h1>
    <p>Testing the fix for "Cannot read properties of null (reading 'user')" error in Leaves pages.</p>

    <div id="app">
        <div class="test-case" :class="testResults.completeData ? 'success' : 'error'">
            <h3>Test 1: Complete Employee Data</h3>
            <p>Testing with complete employee.user data structure</p>
            <employee-display :employee="testData.completeEmployee" />
            <p><strong>Result:</strong> {{ testResults.completeData ? 'PASS' : 'FAIL' }}</p>
        </div>

        <div class="test-case" :class="testResults.nullUser ? 'success' : 'error'">
            <h3>Test 2: Null User Data</h3>
            <p>Testing with null employee.user (should show fallback)</p>
            <employee-display :employee="testData.nullUserEmployee" />
            <p><strong>Result:</strong> {{ testResults.nullUser ? 'PASS' : 'FAIL' }}</p>
        </div>

        <div class="test-case" :class="testResults.nullEmployee ? 'success' : 'error'">
            <h3>Test 3: Null Employee Data</h3>
            <p>Testing with null employee (should show fallback)</p>
            <employee-display :employee="testData.nullEmployee" />
            <p><strong>Result:</strong> {{ testResults.nullEmployee ? 'PASS' : 'FAIL' }}</p>
        </div>

        <div class="test-case" :class="testResults.pageSubtitle ? 'success' : 'error'">
            <h3>Test 4: Page Subtitle Generation</h3>
            <p>Testing page subtitle with different data scenarios</p>
            <div>
                <p><strong>Complete data:</strong> {{ getPageSubtitle(testData.completeLeave, true) }}</p>
                <p><strong>Null user:</strong> {{ getPageSubtitle(testData.nullUserLeave, true) }}</p>
                <p><strong>Non-approver:</strong> {{ getPageSubtitle(testData.completeLeave, false) }}</p>
            </div>
            <p><strong>Result:</strong> {{ testResults.pageSubtitle ? 'PASS' : 'FAIL' }}</p>
        </div>
    </div>

    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    testData: {
                        completeEmployee: {
                            user: {
                                name: 'John Doe',
                                email: 'john.doe@example.com'
                            }
                        },
                        nullUserEmployee: {
                            user: null
                        },
                        nullEmployee: null,
                        completeLeave: {
                            employee: {
                                user: {
                                    name: 'Jane Smith',
                                    email: 'jane.smith@example.com'
                                }
                            },
                            leave_type: {
                                name: 'Annual Leave'
                            },
                            from_date: '2024-01-15',
                            to_date: '2024-01-17'
                        },
                        nullUserLeave: {
                            employee: {
                                user: null
                            },
                            leave_type: {
                                name: 'Sick Leave'
                            },
                            from_date: '2024-01-20',
                            to_date: '2024-01-22'
                        }
                    },
                    testResults: {
                        completeData: false,
                        nullUser: false,
                        nullEmployee: false,
                        pageSubtitle: false
                    }
                };
            },
            methods: {
                getInitials(name) {
                    if (!name) return '--';
                    return name
                        .split(' ')
                        .map(word => word.charAt(0))
                        .join('')
                        .toUpperCase()
                        .slice(0, 2);
                },
                getPageSubtitle(leave, isApprover) {
                    try {
                        if (isApprover && leave.employee?.user?.name) {
                            return `Request by ${leave.employee.user.name}`;
                        }
                        return `${leave.leave_type.name} - 3 days`;
                    } catch (error) {
                        return 'Error generating subtitle';
                    }
                },
                runTests() {
                    // Test 1: Complete data should work
                    try {
                        const name = this.testData.completeEmployee.user.name;
                        this.testResults.completeData = name === 'John Doe';
                    } catch (error) {
                        this.testResults.completeData = false;
                    }

                    // Test 2: Null user should not throw error
                    try {
                        const hasUser = this.testData.nullUserEmployee?.user;
                        this.testResults.nullUser = !hasUser; // Should be false/null
                    } catch (error) {
                        this.testResults.nullUser = false;
                    }

                    // Test 3: Null employee should not throw error
                    try {
                        const hasEmployee = this.testData.nullEmployee?.user;
                        this.testResults.nullEmployee = !hasEmployee; // Should be false/null
                    } catch (error) {
                        this.testResults.nullEmployee = false;
                    }

                    // Test 4: Page subtitle should handle all cases
                    try {
                        const subtitle1 = this.getPageSubtitle(this.testData.completeLeave, true);
                        const subtitle2 = this.getPageSubtitle(this.testData.nullUserLeave, true);
                        const subtitle3 = this.getPageSubtitle(this.testData.completeLeave, false);
                        
                        this.testResults.pageSubtitle = 
                            subtitle1.includes('Jane Smith') &&
                            subtitle2.includes('Sick Leave') &&
                            subtitle3.includes('Annual Leave');
                    } catch (error) {
                        this.testResults.pageSubtitle = false;
                    }
                }
            },
            components: {
                'employee-display': {
                    props: ['employee'],
                    template: `
                        <div v-if="employee?.user" class="employee-card">
                            <div class="avatar avatar-primary">
                                {{ getInitials(employee.user.name) }}
                            </div>
                            <div>
                                <div><strong>{{ employee.user.name }}</strong></div>
                                <div style="font-size: 12px; color: #666;">{{ employee.user.email }}</div>
                            </div>
                        </div>
                        <div v-else class="employee-card">
                            <div class="avatar avatar-neutral">--</div>
                            <div>
                                <div style="color: #666;"><strong>Employee data unavailable</strong></div>
                                <div style="font-size: 12px; color: #999;">--</div>
                            </div>
                        </div>
                    `,
                    methods: {
                        getInitials(name) {
                            if (!name) return '--';
                            return name
                                .split(' ')
                                .map(word => word.charAt(0))
                                .join('')
                                .toUpperCase()
                                .slice(0, 2);
                        }
                    }
                }
            },
            mounted() {
                this.runTests();
            }
        }).mount('#app');
    </script>
</body>
</html>