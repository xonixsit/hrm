<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Navigation Conflict Fix Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        .test-results {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 4px;
        }
        .log-entry {
            font-family: monospace;
            font-size: 12px;
            margin: 2px 0;
            padding: 2px 5px;
            background: #e9ecef;
            border-radius: 2px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Navigation Conflict Detection Fix Test</h1>
        
        <div class="status info">
            <strong>Test Purpose:</strong> Verify that the NavigationConflictDetector is working properly and no longer throwing "Cannot read properties of undefined (reading 'length')" errors.
        </div>
        
        <div class="test-controls">
            <button onclick="testConflictDetector()">Test Conflict Detector</button>
            <button onclick="testNavigationMonitor()">Test Navigation Monitor</button>
            <button onclick="testBreakpointManager()">Test Breakpoint Manager</button>
            <button onclick="simulateNavigation()">Simulate Navigation</button>
            <button onclick="clearLogs()">Clear Logs</button>
        </div>
        
        <div class="test-results">
            <h3>Test Results:</h3>
            <div id="test-output"></div>
        </div>
        
        <div class="test-results">
            <h3>Console Logs:</h3>
            <div id="console-logs"></div>
        </div>
    </div>

    <script type="module">
        // Mock NavigationConflictDetector for testing
        class NavigationConflictDetector {
            constructor() {
                this.activeComponents = [];
                this.conflicts = [];
                this.isEnabled = true;
                this.lastCheck = Date.now();
                
                this.CONFLICT_TYPES = {
                    MULTIPLE_SAME_TYPE: 'multiple_same_type',
                    BREAKPOINT_MISMATCH: 'breakpoint_mismatch',
                    VISIBILITY_CONFLICT: 'visibility_conflict',
                    DUPLICATE_ID: 'duplicate_id',
                    MISSING_COMPONENT: 'missing_component'
                };
                
                this.SEVERITY_LEVELS = {
                    CRITICAL: 'critical',
                    HIGH: 'high',
                    MEDIUM: 'medium',
                    LOW: 'low'
                };
            }
            
            registerComponent(id, type, metadata = {}) {
                if (!this.isEnabled) return;
                
                const component = {
                    id,
                    type,
                    metadata,
                    registeredAt: Date.now(),
                    lastSeen: Date.now()
                };
                
                // Remove existing component with same ID
                this.activeComponents = this.activeComponents.filter(c => c.id !== id);
                
                // Add new component
                this.activeComponents.push(component);
                
                // Check for conflicts after registration
                this.detectConflicts();
                
                return component;
            }
            
            unregisterComponent(id) {
                if (!this.isEnabled) return;
                
                this.activeComponents = this.activeComponents.filter(c => c.id !== id);
                
                // Check for conflicts after unregistration
                this.detectConflicts();
            }
            
            detectConflicts() {
                if (!this.isEnabled) return [];
                
                this.conflicts = [];
                this.lastCheck = Date.now();
                
                // Ensure activeComponents is always an array
                if (!Array.isArray(this.activeComponents)) {
                    this.activeComponents = [];
                }
                
                // Check for multiple components of same type
                this.checkMultipleSameType();
                
                // Check for breakpoint mismatches
                this.checkBreakpointMismatches();
                
                return this.conflicts;
            }
            
            checkMultipleSameType() {
                const typeCounts = {};
                
                this.activeComponents.forEach(component => {
                    typeCounts[component.type] = (typeCounts[component.type] || 0) + 1;
                });
                
                Object.entries(typeCounts).forEach(([type, count]) => {
                    if (count > 1) {
                        this.addConflict({
                            type: this.CONFLICT_TYPES.MULTIPLE_SAME_TYPE,
                            severity: this.SEVERITY_LEVELS.HIGH,
                            message: `Multiple ${type} navigation components detected (${count})`,
                            affectedComponents: this.activeComponents.filter(c => c.type === type),
                            data: { type, count }
                        });
                    }
                });
            }
            
            checkBreakpointMismatches() {
                const currentWidth = window.innerWidth;
                const expectedType = currentWidth >= 1024 ? 'desktop' : 'mobile';
                
                const hasDesktop = this.activeComponents.some(c => c.type === 'desktop');
                const hasMobile = this.activeComponents.some(c => c.type === 'mobile');
                
                if (expectedType === 'desktop' && hasMobile && !hasDesktop) {
                    this.addConflict({
                        type: this.CONFLICT_TYPES.BREAKPOINT_MISMATCH,
                        severity: this.SEVERITY_LEVELS.MEDIUM,
                        message: 'Mobile navigation active on desktop breakpoint',
                        affectedComponents: this.activeComponents.filter(c => c.type === 'mobile'),
                        data: { expectedType, currentWidth }
                    });
                }
                
                if (expectedType === 'mobile' && hasDesktop && !hasMobile) {
                    this.addConflict({
                        type: this.CONFLICT_TYPES.BREAKPOINT_MISMATCH,
                        severity: this.SEVERITY_LEVELS.MEDIUM,
                        message: 'Desktop navigation active on mobile breakpoint',
                        affectedComponents: this.activeComponents.filter(c => c.type === 'desktop'),
                        data: { expectedType, currentWidth }
                    });
                }
            }
            
            addConflict(conflict) {
                const conflictWithId = {
                    ...conflict,
                    id: `conflict_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                    detectedAt: Date.now()
                };
                
                this.conflicts.push(conflictWithId);
                
                return conflictWithId;
            }
            
            getStatus() {
                return {
                    isEnabled: this.isEnabled,
                    activeComponents: this.activeComponents || [],
                    conflicts: this.conflicts || [],
                    hasConflicts: (this.conflicts || []).length > 0,
                    conflictCount: (this.conflicts || []).length,
                    lastCheck: this.lastCheck,
                    componentCount: (this.activeComponents || []).length
                };
            }
            
            reset() {
                this.activeComponents = [];
                this.conflicts = [];
                this.lastCheck = Date.now();
            }
        }

        // Create test instance
        const conflictDetector = new NavigationConflictDetector();
        
        // Make it globally available for testing
        window.conflictDetector = conflictDetector;
        
        // Test functions
        window.testConflictDetector = function() {
            logMessage('Testing NavigationConflictDetector...', 'info');
            
            try {
                // Test basic functionality
                const result1 = conflictDetector.detectConflicts();
                logMessage(`✓ detectConflicts() returned: ${JSON.stringify(result1)}`, 'success');
                
                // Test component registration
                const comp1 = conflictDetector.registerComponent('nav-1', 'desktop');
                logMessage(`✓ registerComponent() returned: ${JSON.stringify(comp1)}`, 'success');
                
                // Test conflict detection with multiple components
                conflictDetector.registerComponent('nav-2', 'desktop');
                const conflicts = conflictDetector.detectConflicts();
                logMessage(`✓ Conflict detection with multiple components: ${conflicts.length} conflicts found`, 'success');
                
                // Test status
                const status = conflictDetector.getStatus();
                logMessage(`✓ getStatus() returned: ${JSON.stringify(status, null, 2)}`, 'success');
                
                // Test reset
                conflictDetector.reset();
                logMessage('✓ reset() completed successfully', 'success');
                
                logMessage('NavigationConflictDetector test completed successfully!', 'success');
                
            } catch (error) {
                logMessage(`✗ NavigationConflictDetector test failed: ${error.message}`, 'error');
                console.error('NavigationConflictDetector test error:', error);
            }
        };
        
        window.testNavigationMonitor = function() {
            logMessage('Testing NavigationMonitor integration...', 'info');
            
            try {
                // Test that conflict detector works with monitor-like calls
                const originalDetectConflicts = conflictDetector.detectConflicts.bind(conflictDetector);
                
                // Simulate monitor wrapping
                conflictDetector.detectConflicts = (...args) => {
                    const conflicts = originalDetectConflicts(...args);
                    if (conflicts && conflicts.length > 0) {
                        logMessage(`Monitor detected ${conflicts.length} conflicts`, 'warning');
                    }
                    return conflicts;
                };
                
                // Test the wrapped function
                const result = conflictDetector.detectConflicts();
                logMessage(`✓ Monitor integration test passed: ${JSON.stringify(result)}`, 'success');
                
                // Restore original function
                conflictDetector.detectConflicts = originalDetectConflicts;
                
                logMessage('NavigationMonitor integration test completed successfully!', 'success');
                
            } catch (error) {
                logMessage(`✗ NavigationMonitor integration test failed: ${error.message}`, 'error');
                console.error('NavigationMonitor integration test error:', error);
            }
        };
        
        window.testBreakpointManager = function() {
            logMessage('Testing BreakpointManager integration...', 'info');
            
            try {
                const currentWidth = window.innerWidth;
                const expectedType = currentWidth >= 1024 ? 'desktop' : 'mobile';
                
                logMessage(`Current window width: ${currentWidth}px`, 'info');
                logMessage(`Expected navigation type: ${expectedType}`, 'info');
                
                // Register appropriate component
                conflictDetector.registerComponent('test-nav', expectedType);
                
                // Check for conflicts
                const conflicts = conflictDetector.detectConflicts();
                
                if (conflicts.length === 0) {
                    logMessage('✓ No breakpoint conflicts detected', 'success');
                } else {
                    logMessage(`⚠ ${conflicts.length} breakpoint conflicts detected`, 'warning');
                    conflicts.forEach(conflict => {
                        logMessage(`  - ${conflict.message}`, 'warning');
                    });
                }
                
                logMessage('BreakpointManager integration test completed!', 'success');
                
            } catch (error) {
                logMessage(`✗ BreakpointManager integration test failed: ${error.message}`, 'error');
                console.error('BreakpointManager integration test error:', error);
            }
        };
        
        window.simulateNavigation = function() {
            logMessage('Simulating navigation scenario...', 'info');
            
            try {
                // Simulate a typical navigation scenario
                logMessage('1. Registering desktop navigation component...', 'info');
                conflictDetector.registerComponent('main-nav-desktop', 'desktop', { 
                    component: 'SidebarNavigation' 
                });
                
                logMessage('2. Registering mobile navigation component...', 'info');
                conflictDetector.registerComponent('main-nav-mobile', 'mobile', { 
                    component: 'MobileNavigation' 
                });
                
                logMessage('3. Detecting conflicts...', 'info');
                const conflicts = conflictDetector.detectConflicts();
                
                if (conflicts.length > 0) {
                    logMessage(`⚠ Found ${conflicts.length} conflicts:`, 'warning');
                    conflicts.forEach((conflict, index) => {
                        logMessage(`  ${index + 1}. ${conflict.message}`, 'warning');
                    });
                } else {
                    logMessage('✓ No conflicts detected in navigation scenario', 'success');
                }
                
                logMessage('4. Getting system status...', 'info');
                const status = conflictDetector.getStatus();
                logMessage(`Active components: ${status.componentCount}`, 'info');
                logMessage(`Total conflicts: ${status.conflictCount}`, 'info');
                
                logMessage('Navigation simulation completed!', 'success');
                
            } catch (error) {
                logMessage(`✗ Navigation simulation failed: ${error.message}`, 'error');
                console.error('Navigation simulation error:', error);
            }
        };
        
        window.clearLogs = function() {
            document.getElementById('test-output').innerHTML = '';
            document.getElementById('console-logs').innerHTML = '';
        };
        
        function logMessage(message, type = 'info') {
            const output = document.getElementById('test-output');
            const timestamp = new Date().toLocaleTimeString();
            
            const logEntry = document.createElement('div');
            logEntry.className = `status ${type}`;
            logEntry.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
            
            output.appendChild(logEntry);
            output.scrollTop = output.scrollHeight;
            
            // Also log to console
            console.log(`[NAV TEST] ${message}`);
        }
        
        // Intercept console messages
        const originalConsoleLog = console.log;
        const originalConsoleError = console.error;
        const originalConsoleWarn = console.warn;
        
        function addConsoleLog(message, type = 'log') {
            const consoleOutput = document.getElementById('console-logs');
            const timestamp = new Date().toLocaleTimeString();
            
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            logEntry.textContent = `[${timestamp}] [${type.toUpperCase()}] ${message}`;
            
            consoleOutput.appendChild(logEntry);
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
        }
        
        console.log = function(...args) {
            addConsoleLog(args.join(' '), 'log');
            originalConsoleLog.apply(console, args);
        };
        
        console.error = function(...args) {
            addConsoleLog(args.join(' '), 'error');
            originalConsoleError.apply(console, args);
        };
        
        console.warn = function(...args) {
            addConsoleLog(args.join(' '), 'warn');
            originalConsoleWarn.apply(console, args);
        };
        
        // Initialize
        logMessage('Navigation Conflict Detection Fix Test initialized', 'success');
        logMessage('Click the test buttons to verify the fix is working', 'info');
        
        // Auto-run basic test
        setTimeout(() => {
            logMessage('Running automatic basic test...', 'info');
            testConflictDetector();
        }, 1000);
    </script>
</body>
</html>