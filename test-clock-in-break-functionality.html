<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clock In/Out & Break Functionality Test</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .status-clocked-out { background-color: #6b7280; }
        .status-clocked-in { background-color: #10b981; }
        .status-on-break { background-color: #f59e0b; }
        
        .btn {
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.2s;
            cursor: pointer;
            border: none;
            min-height: 44px;
        }
        
        .btn-primary {
            background-color: #3b82f6;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #2563eb;
        }
        
        .btn-success {
            background-color: #10b981;
            color: white;
        }
        
        .btn-success:hover {
            background-color: #059669;
        }
        
        .btn-danger {
            background-color: #ef4444;
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #dc2626;
        }
        
        .btn-warning {
            background-color: #f59e0b;
            color: white;
        }
        
        .btn-warning:hover {
            background-color: #d97706;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .log-entry {
            padding: 8px 12px;
            margin: 4px 0;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .log-success { background-color: #d1fae5; color: #065f46; }
        .log-error { background-color: #fee2e2; color: #991b1b; }
        .log-info { background-color: #dbeafe; color: #1e40af; }
        .log-warning { background-color: #fef3c7; color: #92400e; }
    </style>
</head>
<body class="bg-gray-50 p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold text-gray-900 mb-8">Clock In/Out & Break Functionality Test</h1>
        
        <!-- Current Status Display -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Current Status</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="text-center p-4 bg-gray-50 rounded-lg">
                    <div class="text-sm text-gray-600 mb-1">Status</div>
                    <div id="current-status" class="text-lg font-semibold">
                        <span class="status-dot status-clocked-out"></span>
                        Clocked Out
                    </div>
                </div>
                <div class="text-center p-4 bg-gray-50 rounded-lg">
                    <div class="text-sm text-gray-600 mb-1">Work Duration</div>
                    <div id="work-duration" class="text-lg font-semibold text-blue-600">0h 0m 0s</div>
                </div>
                <div class="text-center p-4 bg-gray-50 rounded-lg">
                    <div class="text-sm text-gray-600 mb-1">Break Duration</div>
                    <div id="break-duration" class="text-lg font-semibold text-yellow-600">0h 0m 0s</div>
                </div>
            </div>
        </div>
        
        <!-- Action Buttons -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Actions</h2>
            <div class="flex flex-wrap gap-4">
                <button id="clock-in-out-btn" class="btn btn-success" onclick="handleClockInOut()">
                    Clock In
                </button>
                <button id="break-btn" class="btn btn-warning" onclick="handleBreak()" disabled>
                    Take Break
                </button>
                <button id="refresh-status-btn" class="btn btn-primary" onclick="refreshStatus()">
                    Refresh Status
                </button>
                <button id="test-api-btn" class="btn btn-primary" onclick="testApiConnection()">
                    Test API Connection
                </button>
            </div>
        </div>
        
        <!-- API Test Results -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">API Test Results</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <h3 class="font-medium text-gray-700 mb-2">Endpoint Status</h3>
                    <div id="api-status" class="space-y-2">
                        <div class="flex justify-between items-center p-2 bg-gray-50 rounded">
                            <span>/api/attendance/current</span>
                            <span id="current-api-status" class="text-gray-500">Not tested</span>
                        </div>
                        <div class="flex justify-between items-center p-2 bg-gray-50 rounded">
                            <span>/api/attendance/clock-in</span>
                            <span id="clock-in-api-status" class="text-gray-500">Not tested</span>
                        </div>
                        <div class="flex justify-between items-center p-2 bg-gray-50 rounded">
                            <span>/api/attendance/clock-out</span>
                            <span id="clock-out-api-status" class="text-gray-500">Not tested</span>
                        </div>
                        <div class="flex justify-between items-center p-2 bg-gray-50 rounded">
                            <span>/api/attendance/break-start</span>
                            <span id="break-start-api-status" class="text-gray-500">Not tested</span>
                        </div>
                        <div class="flex justify-between items-center p-2 bg-gray-50 rounded">
                            <span>/api/attendance/break-end</span>
                            <span id="break-end-api-status" class="text-gray-500">Not tested</span>
                        </div>
                    </div>
                </div>
                <div>
                    <h3 class="font-medium text-gray-700 mb-2">Current Session Data</h3>
                    <div id="session-data" class="p-4 bg-gray-50 rounded text-sm font-mono">
                        No session data loaded
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Activity Log -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Activity Log</h2>
            <div id="activity-log" class="space-y-2 max-h-96 overflow-y-auto">
                <div class="log-entry log-info">Test page loaded - ready to test functionality</div>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let currentState = {
            clockedIn: false,
            onBreak: false,
            clockInTime: null,
            breakStartTime: null,
            loading: false
        };
        
        let workTimer = null;
        let breakTimer = null;
        
        // Utility functions
        function log(message, type = 'info') {
            const logContainer = document.getElementById('activity-log');
            const timestamp = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.textContent = `[${timestamp}] ${message}`;
            logContainer.insertBefore(entry, logContainer.firstChild);
            
            // Keep only last 50 entries
            while (logContainer.children.length > 50) {
                logContainer.removeChild(logContainer.lastChild);
            }
        }
        
        function updateStatus() {
            const statusElement = document.getElementById('current-status');
            const clockBtn = document.getElementById('clock-in-out-btn');
            const breakBtn = document.getElementById('break-btn');
            
            if (currentState.onBreak) {
                statusElement.innerHTML = '<span class="status-dot status-on-break"></span>On Break';
                clockBtn.textContent = 'Clock Out';
                clockBtn.className = 'btn btn-danger';
                breakBtn.textContent = 'End Break';
                breakBtn.disabled = false;
            } else if (currentState.clockedIn) {
                statusElement.innerHTML = '<span class="status-dot status-clocked-in"></span>Clocked In';
                clockBtn.textContent = 'Clock Out';
                clockBtn.className = 'btn btn-danger';
                breakBtn.textContent = 'Take Break';
                breakBtn.disabled = false;
            } else {
                statusElement.innerHTML = '<span class="status-dot status-clocked-out"></span>Clocked Out';
                clockBtn.textContent = 'Clock In';
                clockBtn.className = 'btn btn-success';
                breakBtn.textContent = 'Take Break';
                breakBtn.disabled = true;
            }
            
            // Update button states
            if (currentState.loading) {
                clockBtn.disabled = true;
                breakBtn.disabled = true;
                clockBtn.textContent = 'Processing...';
            } else {
                clockBtn.disabled = false;
            }
        }
        
        function updateTimers() {
            if (currentState.clockedIn && currentState.clockInTime) {
                const clockInTime = new Date(currentState.clockInTime);
                const now = new Date();
                const diffMs = now - clockInTime;
                
                const hours = Math.floor(diffMs / (1000 * 60 * 60));
                const minutes = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((diffMs % (1000 * 60)) / 1000);
                
                document.getElementById('work-duration').textContent = `${hours}h ${minutes}m ${seconds}s`;
            } else {
                document.getElementById('work-duration').textContent = '0h 0m 0s';
            }
            
            if (currentState.onBreak && currentState.breakStartTime) {
                const breakStartTime = new Date(currentState.breakStartTime);
                const now = new Date();
                const diffMs = now - breakStartTime;
                
                const hours = Math.floor(diffMs / (1000 * 60 * 60));
                const minutes = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((diffMs % (1000 * 60)) / 1000);
                
                document.getElementById('break-duration').textContent = `${hours}h ${minutes}m ${seconds}s`;
            } else {
                document.getElementById('break-duration').textContent = '0h 0m 0s';
            }
        }
        
        function updateApiStatus(endpoint, status, success = true) {
            const element = document.getElementById(endpoint + '-api-status');
            if (element) {
                element.textContent = status;
                element.className = success ? 'text-green-600' : 'text-red-600';
            }
        }
        
        function updateSessionData(data) {
            const element = document.getElementById('session-data');
            element.textContent = JSON.stringify(data, null, 2);
        }
        
        // API functions
        async function makeApiCall(endpoint, method = 'GET', data = null) {
            try {
                const options = {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                };
                
                // Add CSRF token if available
                const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
                if (csrfToken) {
                    options.headers['X-CSRF-TOKEN'] = csrfToken;
                }
                
                if (data && method !== 'GET') {
                    options.body = JSON.stringify(data);
                }
                
                const response = await fetch(endpoint, options);
                const responseData = await response.json();
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${responseData.message || 'Unknown error'}`);
                }
                
                return responseData;
            } catch (error) {
                console.error(`API call failed for ${endpoint}:`, error);
                throw error;
            }
        }
        
        async function refreshStatus() {
            try {
                log('Fetching current attendance status...');
                const data = await makeApiCall('/api/attendance/current');
                
                currentState.clockedIn = data.clocked_in || false;
                currentState.onBreak = data.on_break || false;
                currentState.clockInTime = data.clock_in_time;
                currentState.breakStartTime = data.break_start_time;
                
                updateStatus();
                updateSessionData(data);
                updateApiStatus('current', 'OK', true);
                
                log(`Status updated - Clocked In: ${currentState.clockedIn}, On Break: ${currentState.onBreak}`, 'success');
            } catch (error) {
                log(`Failed to fetch status: ${error.message}`, 'error');
                updateApiStatus('current', 'Error', false);
            }
        }
        
        async function handleClockInOut() {
            if (currentState.loading) return;
            
            currentState.loading = true;
            updateStatus();
            
            try {
                if (currentState.clockedIn) {
                    log('Attempting to clock out...');
                    const data = await makeApiCall('/api/attendance/clock-out', 'POST');
                    
                    currentState.clockedIn = false;
                    currentState.onBreak = false;
                    currentState.clockInTime = null;
                    currentState.breakStartTime = null;
                    
                    updateApiStatus('clock-out', 'OK', true);
                    log(`Clocked out successfully. Work duration: ${data.work_duration || 'N/A'}`, 'success');
                } else {
                    log('Attempting to clock in...');
                    const data = await makeApiCall('/api/attendance/clock-in', 'POST');
                    
                    currentState.clockedIn = true;
                    currentState.onBreak = false;
                    currentState.clockInTime = data.clock_in_time || new Date().toISOString();
                    
                    updateApiStatus('clock-in', 'OK', true);
                    log('Clocked in successfully', 'success');
                }
            } catch (error) {
                const endpoint = currentState.clockedIn ? 'clock-out' : 'clock-in';
                updateApiStatus(endpoint, 'Error', false);
                log(`Clock ${currentState.clockedIn ? 'out' : 'in'} failed: ${error.message}`, 'error');
            } finally {
                currentState.loading = false;
                updateStatus();
            }
        }
        
        async function handleBreak() {
            if (currentState.loading || !currentState.clockedIn) return;
            
            currentState.loading = true;
            updateStatus();
            
            try {
                if (currentState.onBreak) {
                    log('Attempting to end break...');
                    const data = await makeApiCall('/api/attendance/break-end', 'POST');
                    
                    currentState.onBreak = false;
                    currentState.breakStartTime = null;
                    
                    updateApiStatus('break-end', 'OK', true);
                    log(`Break ended successfully. Break duration: ${data.break_duration || 'N/A'}`, 'success');
                } else {
                    log('Attempting to start break...');
                    const data = await makeApiCall('/api/attendance/break-start', 'POST');
                    
                    currentState.onBreak = true;
                    currentState.breakStartTime = data.break_start_time || new Date().toISOString();
                    
                    updateApiStatus('break-start', 'OK', true);
                    log('Break started successfully', 'success');
                }
            } catch (error) {
                const endpoint = currentState.onBreak ? 'break-end' : 'break-start';
                updateApiStatus(endpoint, 'Error', false);
                log(`${currentState.onBreak ? 'End' : 'Start'} break failed: ${error.message}`, 'error');
            } finally {
                currentState.loading = false;
                updateStatus();
            }
        }
        
        async function testApiConnection() {
            log('Testing API connection...');
            
            // Test each endpoint
            const endpoints = [
                { name: 'current', url: '/api/attendance/current', method: 'GET' }
            ];
            
            for (const endpoint of endpoints) {
                try {
                    await makeApiCall(endpoint.url, endpoint.method);
                    updateApiStatus(endpoint.name, 'OK', true);
                    log(`✓ ${endpoint.url} - OK`, 'success');
                } catch (error) {
                    updateApiStatus(endpoint.name, 'Error', false);
                    log(`✗ ${endpoint.url} - ${error.message}`, 'error');
                }
            }
        }
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            log('Page loaded, initializing...');
            
            // Start timers
            setInterval(updateTimers, 1000);
            
            // Initial status fetch
            refreshStatus();
            
            log('Initialization complete. Ready to test clock in/out and break functionality.');
        });
        
        // Add some helpful keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey || e.metaKey) {
                switch(e.key) {
                    case 'i':
                        e.preventDefault();
                        handleClockInOut();
                        break;
                    case 'b':
                        e.preventDefault();
                        handleBreak();
                        break;
                    case 'r':
                        e.preventDefault();
                        refreshStatus();
                        break;
                }
            }
        });
    </script>
    
    <!-- Instructions -->
    <div class="max-w-4xl mx-auto mt-8 bg-blue-50 border border-blue-200 rounded-lg p-6">
        <h3 class="text-lg font-semibold text-blue-900 mb-3">Testing Instructions</h3>
        <div class="text-blue-800 space-y-2">
            <p><strong>Keyboard Shortcuts:</strong></p>
            <ul class="list-disc list-inside ml-4 space-y-1">
                <li><kbd>Ctrl/Cmd + I</kbd> - Clock In/Out</li>
                <li><kbd>Ctrl/Cmd + B</kbd> - Take/End Break</li>
                <li><kbd>Ctrl/Cmd + R</kbd> - Refresh Status</li>
            </ul>
            <p><strong>Test Sequence:</strong></p>
            <ol class="list-decimal list-inside ml-4 space-y-1">
                <li>Click "Test API Connection" to verify endpoints</li>
                <li>Click "Clock In" to start work session</li>
                <li>Wait a few seconds and observe the work timer</li>
                <li>Click "Take Break" to start a break</li>
                <li>Wait a few seconds and observe the break timer</li>
                <li>Click "End Break" to resume work</li>
                <li>Click "Clock Out" to end the session</li>
            </ol>
        </div>
    </div>
</body>
</html>