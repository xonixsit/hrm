<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Theme System Test</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            transition: background-color 0.3s, color 0.3s;
        }
        
        /* Light theme (default) */
        body {
            background-color: #fafafa;
            color: #111827;
        }
        
        /* Dark theme */
        .theme-dark body {
            background-color: #0a0a0a;
            color: #fafafa;
        }
        
        .test-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            border: 1px solid #e5e5e5;
            border-radius: 8px;
            background: white;
            transition: all 0.3s;
        }
        
        .theme-dark .test-container {
            border-color: #404040;
            background: #111827;
        }
        
        .data-table-container {
            background: white;
            border: 1px solid #e5e5e5;
            border-radius: 8px;
            overflow: hidden;
            margin: 20px 0;
            transition: all 0.3s;
        }
        
        .theme-dark .data-table-container {
            background: #111827;
            border-color: #404040;
        }
        
        .table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .table th,
        .table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e5e5e5;
        }
        
        .theme-dark .table th,
        .theme-dark .table td {
            border-bottom-color: #404040;
        }
        
        .table th {
            background: #f5f5f5;
            font-weight: 600;
            color: #111827;
        }
        
        .theme-dark .table th {
            background: #262626;
            color: #fafafa;
        }
        
        .table td {
            color: #111827;
        }
        
        .theme-dark .table td {
            color: #d4d4d4;
        }
        
        .controls {
            margin: 20px 0;
            padding: 20px;
            background: #f5f5f5;
            border-radius: 8px;
            transition: all 0.3s;
        }
        
        .theme-dark .controls {
            background: #262626;
        }
        
        button {
            padding: 8px 16px;
            margin: 5px;
            border: 1px solid #d4d4d4;
            border-radius: 4px;
            background: white;
            color: #111827;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .theme-dark button {
            background: #404040;
            color: #fafafa;
            border-color: #525252;
        }
        
        button:hover {
            background: #f5f5f5;
        }
        
        .theme-dark button:hover {
            background: #525252;
        }
        
        .status {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
            background: #e0f2fe;
            color: #0369a1;
        }
        
        .theme-dark .status {
            background: #1e3a8a;
            color: #93c5fd;
        }
        
        .error {
            background: #fef2f2;
            color: #dc2626;
        }
        
        .theme-dark .error {
            background: #7f1d1d;
            color: #fca5a5;
        }
        
        .success {
            background: #f0fdf4;
            color: #16a34a;
        }
        
        .theme-dark .success {
            background: #14532d;
            color: #86efac;
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="test-container">
            <h1>Enhanced Theme System Test</h1>
            
            <div class="controls">
                <h3>Theme Controls</h3>
                <button @click="setLightTheme">Set Light Theme</button>
                <button @click="setDarkTheme">Set Dark Theme</button>
                <button @click="toggleTheme">Toggle Theme</button>
                <button @click="useSystemTheme">Use System Theme</button>
                <button @click="debugTheme">Debug Theme State</button>
                <button @click="validateTheme">Validate Theme State</button>
                <button @click="resetTheme">Reset to Default</button>
                <button @click="testRecovery">Test Recovery</button>
            </div>
            
            <div class="status">
                <strong>Current Status:</strong><br>
                Active Theme: {{ activeTheme }}<br>
                Current Theme: {{ currentTheme }}<br>
                System Theme: {{ systemTheme }}<br>
                Use System: {{ isSystemThemePreferred }}<br>
                Is Dark: {{ isDark }}
            </div>
            
            <div v-if="validationResult" :class="['status', validationResult.isValid ? 'success' : 'error']">
                <strong>Validation Result:</strong><br>
                Valid: {{ validationResult.isValid }}<br>
                <div v-if="validationResult.issues.length">
                    Issues:
                    <ul>
                        <li v-for="issue in validationResult.issues" :key="issue">{{ issue }}</li>
                    </ul>
                </div>
            </div>
            
            <div class="data-table-container">
                <h3>Sample Employee Table</h3>
                <table class="table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Department</th>
                            <th>Job Title</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>John Doe</td>
                            <td>john.doe@company.com</td>
                            <td>Engineering</td>
                            <td>Senior Developer</td>
                        </tr>
                        <tr>
                            <td>Jane Smith</td>
                            <td>jane.smith@company.com</td>
                            <td>Marketing</td>
                            <td>Marketing Manager</td>
                        </tr>
                        <tr>
                            <td>Bob Johnson</td>
                            <td>bob.johnson@company.com</td>
                            <td>Sales</td>
                            <td>Sales Representative</td>
                        </tr>
                        <tr>
                            <td>Alice Brown</td>
                            <td>alice.brown@company.com</td>
                            <td>HR</td>
                            <td>HR Specialist</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, computed, onMounted } = Vue;

        // Simplified theme composable for testing
        function useTheme() {
            const currentTheme = ref('light');
            const systemTheme = ref('light');
            const isSystemThemePreferred = ref(false);

            const activeTheme = computed(() => {
                return isSystemThemePreferred.value ? systemTheme.value : currentTheme.value;
            });

            const isDark = computed(() => activeTheme.value === 'dark');

            const detectSystemTheme = () => {
                try {
                    const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)');
                    return mediaQuery.matches ? 'dark' : 'light';
                } catch (error) {
                    console.warn('Failed to detect system theme:', error);
                    return 'light';
                }
            };

            const validateTheme = (theme) => {
                return theme && typeof theme === 'string' && ['light', 'dark'].includes(theme);
            };

            const cleanupAndApplyTheme = (theme) => {
                try {
                    const root = document.documentElement;
                    const safeTheme = validateTheme(theme) ? theme : 'light';
                    
                    // Remove all theme classes
                    root.classList.remove('theme-light', 'theme-dark');
                    
                    // Add correct theme class
                    root.classList.add(`theme-${safeTheme}`);
                    
                    console.log(`Applied theme: ${safeTheme}`);
                } catch (error) {
                    console.error('Failed to apply theme:', error);
                }
            };

            const setTheme = (theme) => {
                if (!validateTheme(theme)) {
                    console.warn(`Invalid theme: ${theme}`);
                    return;
                }
                currentTheme.value = theme;
                isSystemThemePreferred.value = false;
                cleanupAndApplyTheme(theme);
            };

            const useSystemTheme = () => {
                isSystemThemePreferred.value = true;
                const detected = detectSystemTheme();
                systemTheme.value = detected;
                cleanupAndApplyTheme(detected);
            };

            const toggleTheme = () => {
                const newTheme = activeTheme.value === 'light' ? 'dark' : 'light';
                setTheme(newTheme);
            };

            const validateThemeState = () => {
                const issues = [];
                
                if (!validateTheme(currentTheme.value)) {
                    issues.push(`Invalid current theme: ${currentTheme.value}`);
                }
                
                if (!validateTheme(systemTheme.value)) {
                    issues.push(`Invalid system theme: ${systemTheme.value}`);
                }
                
                const root = document.documentElement;
                const hasLightClass = root.classList.contains('theme-light');
                const hasDarkClass = root.classList.contains('theme-dark');
                
                if (!hasLightClass && !hasDarkClass) {
                    issues.push('No theme class found on document root');
                }
                
                if (hasLightClass && hasDarkClass) {
                    issues.push('Multiple theme classes found on document root');
                }
                
                return {
                    isValid: issues.length === 0,
                    issues
                };
            };

            const resetThemeToDefault = () => {
                currentTheme.value = 'light';
                systemTheme.value = detectSystemTheme();
                isSystemThemePreferred.value = false;
                cleanupAndApplyTheme('light');
            };

            const debugThemeState = () => {
                console.group('🎨 Theme Debug Info');
                console.log('Current theme:', currentTheme.value);
                console.log('System theme:', systemTheme.value);
                console.log('Active theme:', activeTheme.value);
                console.log('Use system theme:', isSystemThemePreferred.value);
                console.log('Is dark:', isDark.value);
                console.log('DOM theme class:', document.documentElement.className);
                console.groupEnd();
            };

            const initializeTheme = () => {
                systemTheme.value = detectSystemTheme();
                cleanupAndApplyTheme('light'); // Default to light theme
            };

            return {
                currentTheme,
                systemTheme,
                activeTheme,
                isDark,
                isSystemThemePreferred,
                setTheme,
                toggleTheme,
                useSystemTheme,
                validateThemeState,
                resetThemeToDefault,
                debugThemeState,
                initializeTheme
            };
        }

        createApp({
            setup() {
                const theme = useTheme();
                const validationResult = ref(null);

                const setLightTheme = () => {
                    theme.setTheme('light');
                    validationResult.value = null;
                };

                const setDarkTheme = () => {
                    theme.setTheme('dark');
                    validationResult.value = null;
                };

                const toggleTheme = () => {
                    theme.toggleTheme();
                    validationResult.value = null;
                };

                const useSystemTheme = () => {
                    theme.useSystemTheme();
                    validationResult.value = null;
                };

                const debugTheme = () => {
                    theme.debugThemeState();
                };

                const validateTheme = () => {
                    validationResult.value = theme.validateThemeState();
                };

                const resetTheme = () => {
                    theme.resetThemeToDefault();
                    validationResult.value = null;
                };

                const testRecovery = () => {
                    // Simulate corrupted state
                    document.documentElement.classList.add('theme-light', 'theme-dark');
                    validationResult.value = theme.validateThemeState();
                    
                    // Then recover
                    setTimeout(() => {
                        theme.resetThemeToDefault();
                        validationResult.value = theme.validateThemeState();
                    }, 1000);
                };

                onMounted(() => {
                    theme.initializeTheme();
                });

                return {
                    ...theme,
                    validationResult,
                    setLightTheme,
                    setDarkTheme,
                    toggleTheme,
                    useSystemTheme,
                    debugTheme,
                    validateTheme,
                    resetTheme,
                    testRecovery
                };
            }
        }).mount('#app');
    </script>
</body>
</html>